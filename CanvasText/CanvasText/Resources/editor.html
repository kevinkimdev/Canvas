<!DOCTYPE html><html><head><title>Canvas</title></head><body><script>
// ShareJS v0.7.37
(function(w){"object"===typeof exports&&"undefined"!==typeof module?module.exports=w():"function"===typeof define&&define.amd?define([],w):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).sharejs=w()})(function(){return function b(p,g,h){function l(d,f){if(!g[d]){if(!p[d]){var a="function"==typeof require&&require;if(!f&&a)return a(d,!0);if(q)return q(d,!0);a=Error("Cannot find module '"+d+"'");throw a.code="MODULE_NOT_FOUND",a;}a=g[d]={exports:{}};
p[d][0].call(a.exports,function(a){var c=p[d][1][a];return l(c?c:a)},a,a.exports,b,p,g,h)}return g[d].exports}for(var q="function"==typeof require&&require,n=0;n<h.length;n++)l(h[n]);return l}({1:[function(b,p,g){function h(d){for(var f in d)return!0;return!1}var l=b("./doc").Doc,q=b("./query").Query,n=b("./emitter");b=g.Connection=function(d){n.EventEmitter.call(this);this.collections={};this.nextQueryId=1;this.queries={};this.state="disconnected";this.canSend=!1;this._retryInterval=null;this.reset();
this.debug=!1;this.messageBuffer=[];this.bindToSocket(d)};n.mixin(b);b.prototype.bindToSocket=function(d){this.socket&&(delete this.socket.onopen,delete this.socket.onclose,delete this.socket.onmessage,delete this.socket.onerror);this.socket=d;this.state=0===d.readyState||1===d.readyState?"connecting":"disconnected";this.canSend="connecting"===this.state&&d.canSendWhileConnecting;this._setupRetry();var f=this;d.onmessage=function(a){var e=a.data;e||(e=a);"string"===typeof e&&(e=JSON.parse(e));f.debug&&
console.log("RECV",JSON.stringify(e));for(f.messageBuffer.push({t:(new Date).toTimeString(),recv:JSON.stringify(e)});100<f.messageBuffer.length;)f.messageBuffer.shift();try{f.handleMessage(e)}catch(c){f.emit("error",c,e)}};d.onopen=function(){f._setState("connecting")};d.onerror=function(a){f.emit("connection error",a)};d.onclose=function(a){f._setState("disconnected",a);"Closed"!==a&&"Stopped by server"!==a||f._setState("stopped",a)}};b.prototype.handleMessage=function(d){switch(d.a){case "init":if(0!==
d.protocol)throw Error("Invalid protocol version");if("string"!=typeof d.id)throw Error("Invalid client id");this.id=d.id;this._setState("connected");break;case "qfetch":case "qsub":case "q":case "qunsub":var f=this.queries[d.id];f&&f._onMessage(d);break;case "bs":var f=d.s,a;for(a in f)for(var e in f[a]){var c=this.get(a,e);if(!c){console.warn("Message for unknown doc. Ignoring.",d);break}d=f[a][e];"object"===typeof d?c._handleSubscribe(d.error,d):c._handleSubscribe(null,null)}break;default:(c=this.getExisting(d.c,
d.d))&&c._onMessage(d)}};b.prototype.reset=function(){this.id=null;this.seq=1};b.prototype._setupRetry=function(){if(!this.canSend)clearInterval(this._retryInterval),this._retryInterval=null;else if(null==this._retryInterval){var d=this;this._retryInterval=setInterval(function(){for(var f in d.collections){var a=d.collections[f],e;for(e in a)a[e].retry()}},1E3)}};b.prototype._setState=function(d,f){if(this.state!==d){if("connecting"===d&&"disconnected"!==this.state&&"stopped"!==this.state||"connected"===
d&&"connecting"!==this.state)throw Error("Cannot transition directly from "+this.state+" to "+d);this.state=d;this.canSend="connecting"===d&&this.socket.canSendWhileConnecting||"connected"===d;this._setupRetry();"disconnected"===d&&this.reset();this.emit(d,f);this.bsStart();for(var a in this.queries)this.queries[a]._onConnectionStateChanged(d,f);for(var e in this.collections){a=this.collections[e];for(var c in a)a[c]._onConnectionStateChanged(d,f)}this.bsEnd()}};b.prototype.bsStart=function(){this.subscribeData=
this.subscribeData||{}};b.prototype.bsEnd=function(){h(this.subscribeData)&&this.send({a:"bs",s:this.subscribeData});this.subscribeData=null};b.prototype.sendSubscribe=function(d,f,a){if(this.subscribeData){var e=this.subscribeData;e[d]||(e[d]={});e[d][f]=a||null}else d={a:"sub",c:d,d:f},null!=a&&(d.v=a),this.send(d)};b.prototype.sendFetch=function(d,f,a){d={a:"fetch",c:d,d:f};null!=a&&(d.v=a);this.send(d)};b.prototype.sendUnsubscribe=function(d,f){this.send({a:"unsub",c:d,d:f})};b.prototype.sendOp=
function(d,f,a,e){d={a:"op",c:d,d:f,v:a,src:e.src,seq:e.seq};e.op&&(d.op=e.op);e.create&&(d.create=e.create);e.del&&(d.del=e.del);this.send(d)};b.prototype.send=function(d){this.debug&&console.log("SEND",JSON.stringify(d));for(this.messageBuffer.push({t:Date.now(),send:JSON.stringify(d)});100<this.messageBuffer.length;)this.messageBuffer.shift();this.socket.canSendJSON||(d=JSON.stringify(d));this.socket.send(d)};b.prototype.disconnect=function(){this.socket.close()};b.prototype.getExisting=function(d,
f){if(this.collections[d])return this.collections[d][f]};b.prototype.getOrCreate=function(d,f,a){console.trace("getOrCreate is deprecated. Use get() instead");return this.get(d,f,a)};b.prototype.get=function(d,f,a){var e=this.collections[d];e||(e=this.collections[d]={});var c=e[f];c||(c=e[f]=new l(this,d,f),this.emit("doc",c));a&&void 0!==a.data&&!c.state&&c.ingestData(a);return c};b.prototype._destroyDoc=function(d){var f=this.collections[d.collection];f&&(delete f[d.name],h(f)||delete this.collections[d.collection])};
b.prototype._createQuery=function(d,f,a,e,c){if("fetch"!==d&&"sub"!==d)throw Error("Invalid query type: "+d);e||(e={});var r=this.nextQueryId++;d=new q(d,this,r,f,a,e,c);this.queries[r]=d;d._execute();return d};b.prototype._destroyQuery=function(d){delete this.queries[d.id]};b.prototype.createFetchQuery=function(d,f,a,e){return this._createQuery("fetch",d,f,a,e)};b.prototype.createSubscribeQuery=function(d,f,a,e){return this._createQuery("sub",d,f,a,e)}},{"./doc":2,"./emitter":3,"./query":5}],2:[function(b,
p,g){var h=b("../types").ottypes,l=b("./emitter");b=g.Doc=function(a,e,c){l.EventEmitter.call(this);this.connection=a;this.collection=e;this.name=c;this.version=this.type=null;this.snapshot=void 0;this.state=this.action=null;this.wantSubscribe=this.subscribed=!1;this._subscribeCallbacks=[];this.provides={};this.editingContexts=[];this.inflightData=null;this.pendingData=[];this._getLatestTimeout=this.type=null};l.mixin(b);b.prototype.destroy=function(a){var e=this;this.unsubscribe(function(){if(e.hasPending())e.once("nothing pending",
function(){e.connection._destroyDoc(e)});else e.connection._destroyDoc(e);e.removeContexts();a&&a()})};b.prototype._setType=function(a){if("string"===typeof a){if(!h[a])throw Error("Missing type "+a+" "+this.collection+" "+this.name);a=h[a]}this.removeContexts();this.type=a;a?a.api&&(this.provides=a.api.provides):(this.provides={},this.snapshot=void 0)};b.prototype.ingestData=function(a){if("number"!==typeof a.v)throw Error("Missing version in ingested data "+this.collection+" "+this.name);this.state?
this.version>=a.v||console.warn("Ignoring ingest data for",this.collection,this.name,"\n  in state:",this.state,"\n  version:",this.version,"\n  snapshot:\n",this.snapshot,"\n  incoming data:\n",a):(this.version=a.v,this.snapshot=a.data,this._setType(a.type),this.state="ready",this.emit("ready"))};b.prototype.getSnapshot=function(){return this.snapshot};b.prototype.whenReady=function(a){if("ready"===this.state)a();else this.once("ready",a)};b.prototype.hasPending=function(){return null!=this.action||
null!=this.inflightData||!!this.pendingData.length};b.prototype._emitNothingPending=function(){this.hasPending()||this.emit("nothing pending")};b.prototype._send=function(a){a.c=this.collection;a.d=this.name;this.connection.send(a)};b.prototype._handleSubscribe=function(a,e){a&&"Already subscribed"!==a?(console.error("Could not subscribe:",a,this.collection,this.name),this.emit("error",a),this._setWantSubscribe(!1,null,a)):(e&&this.ingestData(e),this.subscribed=!0,this._clearAction(),this.emit("subscribe"),
this._finishSub())};b.prototype._onMessage=function(a){if(a.c!==this.collection||a.d!==this.name)throw console.error("Got message for wrong document.",this.collection,this.name,a),Error("Got message for wrong document.");switch(a.a){case "fetch":a.data&&this.ingestData(a.data);"fetch"===this.wantSubscribe&&(this.wantSubscribe=!1);this._clearAction();this._finishSub(a.error);break;case "sub":this._handleSubscribe(a.error,a.data);break;case "unsub":this.subscribed=!1;this.emit("unsubscribe");this._clearAction();
this._finishSub(a.error);break;case "ack":a.error&&"Op already submitted"!==a.error&&(this.inflightData?(console.warn("Operation was rejected ("+a.error+"). Trying to rollback change locally."),this._tryRollback(this.inflightData),this._clearInflightOp(a.error)):console.warn("Second acknowledgement message (error) received",a,this));break;case "op":if(this.inflightData&&a.src===this.inflightData.src&&a.seq===this.inflightData.seq){this._opAcknowledged(a);break}if(null==this.version||a.v>this.version){this._getLatestOps();
break}if(a.v<this.version)break;this.inflightData&&f(this.inflightData,a);for(var e=0;e<this.pendingData.length;e++)f(this.pendingData[e],a);this.version++;this._otApply(a,!1);break;case "meta":console.warn("Unhandled meta op:",a);break;default:console.warn("Unhandled document message:",a)}};b.prototype._getLatestOps=function(){var a=this,e=!1;a._getLatestTimeout?e=!0:a.connection.sendFetch(a.collection,a.name,a.version);clearTimeout(a._getLatestTimeout);a._getLatestTimeout=setTimeout(function(){a._getLatestTimeout=
null;e&&a.connection.sendFetch(a.collection,a.name,a.version)},5E3)};b.prototype._onConnectionStateChanged=function(){this.connection.canSend?this.flush():(this.subscribed=!1,this._clearAction())};b.prototype._clearAction=function(){this.action=null;this.flush();this._emitNothingPending()};b.prototype.flush=function(){if(this.connection.canSend&&!this.inflightData){for(var a;this.pendingData.length&&n(a=this.pendingData[0]);){for(var e=a.callbacks,c=0;c<e.length;c++)e[c](a.error);this.pendingData.shift()}!this.paused&&
this.pendingData.length?this._sendOpData():this.action||((a="ready"===this.state?this.version:null,this.subscribed&&!this.wantSubscribe)?(this.action="unsubscribe",this.connection.sendUnsubscribe(this.collection,this.name)):this.subscribed||"fetch"!==this.wantSubscribe?!this.subscribed&&this.wantSubscribe&&(this.action="subscribe",this.connection.sendSubscribe(this.collection,this.name,a)):(this.action="fetch",this.connection.sendFetch(this.collection,this.name,a)))}};b.prototype._setWantSubscribe=
function(a,e,c){if(this.subscribed===this.wantSubscribe&&(this.subscribed===a||"fetch"===a&&this.subscribed))e&&e(c);else{if("fetch"!==a||!0!==this.wantSubscribe)this.wantSubscribe=a;e&&this._subscribeCallbacks.push(e);this.flush()}};b.prototype.subscribe=function(a){this._setWantSubscribe(!0,a)};b.prototype.unsubscribe=function(a){this._setWantSubscribe(!1,a)};b.prototype.fetch=function(a){this._setWantSubscribe("fetch",a)};b.prototype._finishSub=function(a){if(this._subscribeCallbacks.length){for(var e=
0;e<this._subscribeCallbacks.length;e++)this._subscribeCallbacks[e](a);this._subscribeCallbacks.length=0}};var q=function(a){delete a.op;delete a.create;delete a.del},n=function(a){return!a.op&&!a.create&&!a.del},d=function(a,e,c){if(e.create&&c.del)q(e);else if(e.create&&c.op){var r=void 0===e.create.data?a.create():e.create.data;e.create.data=a.apply(r,c.op)}else if(n(e))e.create=c.create,e.del=c.del,e.op=c.op;else if(e.op&&c.op&&a.compose)e.op=a.compose(e.op,c.op);else return!1;return!0},f=function(a,
e){if(e.create||e.del)return q(a);if(a.create)throw Error("Invalid state. This is a bug. "+this.collection+" "+this.name);if(a.del)return q(e);if(e.op&&a.op)if(a.type.transformX){var c=a.type.transformX(a.op,e.op);a.op=c[0];e.op=c[1]}else{var c=a.type.transform(a.op,e.op,"left"),r=a.type.transform(e.op,a.op,"right");a.op=c;e.op=r}};b.prototype._otApply=function(a,e){this.locked=!0;if(a.create){var c=a.create;this._setType(c.type);this.snapshot=this.type.create(c.data);this.once("unlock",function(){this.emit("create",
e)})}else if(a.del){var r=this.snapshot;this._setType(null);this.once("unlock",function(){this.emit("del",e,r)})}else if(a.op){if(!this.type)throw Error("Document does not exist. "+this.collection+" "+this.name);for(var d=this.type,f=a.op,c=0;c<this.editingContexts.length;c++){var n=this.editingContexts[c];n!=e&&n._beforeOp&&n._beforeOp(a.op)}this.emit("before op",f,e);if(this.incremental&&d.incrementalApply){var m=this;d.incrementalApply(this.snapshot,f,function(a,c){m.snapshot=c;m.emit("op",a,e)})}else this.snapshot=
d.apply(this.snapshot,f),this.emit("op",f,e)}this.locked=!1;this.emit("unlock");if(a.op){d=this.editingContexts;for(c=0;c<d.length;c++)n=d[c],n!=e&&n._onOp&&n._onOp(a.op);for(c=0;c<d.length;c++)d[c].shouldBeRemoved&&d.splice(c--,1);return this.emit("after op",a.op,e)}};b.prototype.retry=function(){if(this.inflightData){var a=5E3*Math.pow(2,this.inflightData.retries);this.inflightData.sentAt<Date.now()-a&&(this.connection.emit("retry",this),this._sendOpData())}};b.prototype._sendOpData=function(){var a=
this.connection.id;if(a){this.inflightData||(this.inflightData=this.pendingData.shift());var e=this.inflightData;if(!e)throw Error("no data to send on call to _sendOpData");e.sentAt=Date.now();e.retries=null==e.retries?0:e.retries+1;null==e.seq&&(e.seq=this.connection.seq++);this.connection.sendOp(this.collection,this.name,this.version,e);null==e.src&&(e.src=a)}};b.prototype._submitOpData=function(a,e,c){"function"===typeof e&&(c=e,e=!0);null==e&&(e=!0);if(this.locked){a="Cannot call submitOp from inside an 'op' event handler. "+
this.collection+" "+this.name;if(c)return c(a);throw Error(a);}if(a.op){if(!this.type){a="Document has not been created";if(c)return c(a);throw Error(a);}this.type.normalize&&(a.op=this.type.normalize(a.op))}this.state||(this.state="floating");a.type=this.type;a.callbacks=[];var r;r=this.pendingData[this.pendingData.length-1];r&&d(this.type,r,a)||(r=a,this.pendingData.push(a));c&&r.callbacks.push(c);this._otApply(a,e);var f=this;setTimeout(function(){f.flush()},0)};b.prototype.submitOp=function(a,
e,c){this._submitOpData({op:a},e,c)};b.prototype.create=function(a,e,c,r){"function"===typeof e&&(c=e,e=void 0);if(this.type){if(r)return r("Document already exists");throw Error("Document already exists");}this._submitOpData({create:{type:a,data:e}},c,r)};b.prototype.del=function(a,e){if(!this.type){if(e)return e("Document does not exist");throw Error("Document does not exist");}this._submitOpData({del:!0},a,e)};b.prototype.pause=function(){this.paused=!0};b.prototype.resume=function(){this.paused=
!1;this.flush()};b.prototype._tryRollback=function(a){if(a.create)this._setType(null),"floating"===this.state?this.state=null:console.warn("Rollback a create from state "+this.state);else if(a.op&&a.type.invert){a.op=a.type.invert(a.op);for(var e=0;e<this.pendingData.length;e++)f(this.pendingData[e],a);this._otApply(a,!1)}else if(a.op||a.del)this._setType(null),this.state=this.version=null,this.subscribed=!1,this.emit("error","Op apply failed and the operation could not be reverted"),this.fetch(),
this.flush()};b.prototype._clearInflightOp=function(a){for(var e=this.inflightData.callbacks,c=0;c<e.length;c++)e[c](a||this.inflightData.error);this.inflightData=null;this.flush();this._emitNothingPending()};b.prototype._opAcknowledged=function(a){if(!this.state)throw Error("opAcknowledged called from a null state. This should never happen. "+this.collection+" "+this.name);if("floating"===this.state){if(!this.inflightData.create)throw Error("Cannot acknowledge an op. "+this.collection+" "+this.name);
this.version=a.v;this.state="ready";var e=this;setTimeout(function(){e.emit("ready")},0)}else if(a.v!==this.version)throw Error("Invalid version from server. This can happen when you submit ops in a submitOp callback. Expected: "+this.version+" Message version: "+a.v+" "+this.collection+" "+this.name);this.version++;this._clearInflightOp()};b.prototype.createContext=function(){var a=this.type;if(!a)throw Error("Missing type "+this.collection+" "+this.name);var e=this,c={getSnapshot:function(){return e.snapshot},
submitOp:function(a,r){e.submitOp(a,c,r)},destroy:function(){this.detach&&(this.detach(),delete this.detach);delete this._onOp;this.shouldBeRemoved=!0},_doc:this};if(a.api)for(var r in a.api)c[r]=a.api[r];else c.provides={};this.editingContexts.push(c);return c};b.prototype.removeContexts=function(){for(var a=0;a<this.editingContexts.length;a++)this.editingContexts[a].destroy();this.editingContexts.length=0}},{"../types":7,"./emitter":3}],3:[function(b,p,g){var h=b("events").EventEmitter;g.EventEmitter=
h;g.mixin=function(b){for(var q in h.prototype)b.prototype[q]=h.prototype[q]}},{events:10}],4:[function(b,p,g){g.Connection=b("./connection").Connection;g.Doc=b("./doc").Doc;b("./textarea");b=b("../types");g.ottypes=b.ottypes;g.registerType=b.registerType},{"../types":7,"./connection":1,"./doc":2,"./textarea":6}],5:[function(b,p,g){var h=b("./emitter");b=g.Query=function(b,q,n,d,f,a,e){h.EventEmitter.call(this);this.type=b;this.connection=q;this.id=n;this.collection=d;this.query=f;this.docMode=a.docMode;
"subscribe"===this.docMode&&(this.docMode="sub");this.poll=a.poll;this.backend=a.backend||a.source;this.knownDocs=a.knownDocs||[];this.results=[];this.ready=!1;this.callback=e};h.mixin(b);b.prototype.action="qsub";b.prototype._execute=function(){if(this.connection.canSend){if(this.docMode)for(var b={},h=0;h<this.knownDocs.length;h++){var n=this.knownDocs[h];null!=n.version&&((b[n.collection]=b[n.collection]||{})[n.name]=n.version)}h={a:"q"+this.type,id:this.id,c:this.collection,o:{},q:this.query};
this.docMode&&(h.o.m=this.docMode,h.o.vs=b);null!=this.backend&&(h.o.b=this.backend);void 0!==this.poll&&(h.o.p=this.poll);this.connection.send(h)}};b.prototype._dataToDocs=function(b){for(var h=[],n,d=0;d<b.length;d++){var f=b[d];f.type?n=f.type:f.type=n;f=this.connection.get(f.c||this.collection,f.d,f);h.push(f)}return h};b.prototype.destroy=function(){this.connection.canSend&&"sub"===this.type&&this.connection.send({a:"qunsub",id:this.id});this.connection._destroyQuery(this)};b.prototype._onConnectionStateChanged=
function(b,h){"connecting"===this.connection.state&&this._execute()};b.prototype._onMessage=function(b){if("qfetch"===b.a!==("fetch"===this.type))console.warn("Invalid message sent to query",b,this);else switch(b.error&&this.emit("error",b.error),b.a){case "qfetch":var h=b.data?this._dataToDocs(b.data):void 0;this.callback&&this.callback(b.error,h,b.extra);this.connection._destroyQuery(this);break;case "q":if(b.diff){for(h=0;h<b.diff.length;h++){var n=b.diff[h];"insert"===n.type&&(n.values=this._dataToDocs(n.values))}for(h=
0;h<b.diff.length;h++)switch(n=b.diff[h],n.type){case "insert":var d=n.values;Array.prototype.splice.apply(this.results,[n.index,0].concat(d));this.emit("insert",d,n.index);break;case "remove":d=n.howMany||1;d=this.results.splice(n.index,d);this.emit("remove",d,n.index);break;case "move":d=n.howMany||1,d=this.results.splice(n.from,d),Array.prototype.splice.apply(this.results,[n.to,0].concat(d)),this.emit("move",d,n.from,n.to)}}void 0!==b.extra&&this.emit("extra",b.extra);break;case "qsub":b.error||
(h=this.results,this.results=this.knownDocs=this._dataToDocs(b.data),this.extra=b.extra,this.ready=!0,this.emit("change",this.results,h)),this.callback&&(this.callback(b.error,this.results,this.extra),delete this.callback)}};b.prototype.setQuery=function(b){if("sub"!==this.type)throw Error("cannot change a fetch query");this.query=b;this.connection.canSend&&(this.connection.send({a:"qunsub",id:this.id}),this._execute())}},{"./emitter":3}],6:[function(b,p,g){b("./doc").Doc.prototype.attachTextarea=
function(b,l){l||(l=this.createContext());if(!l.provides.text)throw Error("Cannot attach to non-text document");b.value=l.get();var q,n=function(a,e){if(e)var d=[e(b.selectionStart),e(b.selectionEnd)];var f=b.scrollTop;b.value=a;q=b.value;b.scrollTop!==f&&(b.scrollTop=f);d&&window.document.activeElement===b&&(b.selectionStart=d[0],b.selectionEnd=d[1])};n(l.get());l.onInsert=function(a,e){var d=b.value.replace(/\r\n/g,"\n");n(d.slice(0,a)+e+d.slice(a),function(d){return a<d?d+e.length:d})};l.onRemove=
function(a,e){var d=b.value.replace(/\r\n/g,"\n");n(d.slice(0,a)+d.slice(a+e),function(d){return a<d?d-Math.min(e,d-a):d})};for(var d=function(a){setTimeout(function(){if(b.value!==q){q=b.value;var a=l,e=l.get(),c=b.value.replace(/\r\n/g,"\n");if(e!==c){for(var d=0;e.charAt(d)===c.charAt(d);)d++;for(var f=0;e.charAt(e.length-1-f)===c.charAt(c.length-1-f)&&f+d<e.length&&f+d<c.length;)f++;e.length!==d+f&&a.remove(d,e.length-d-f);c.length!==d+f&&a.insert(d,c.slice(d,c.length-f))}}},0)},f="textInput keydown keyup select cut paste".split(" "),
a=0;a<f.length;a++){var e=f[a];b.addEventListener?b.addEventListener(e,d,!1):b.attachEvent("on"+e,d)}l.detach=function(){for(var a=0;a<f.length;a++){var e=f[a];b.removeEventListener?b.removeEventListener(e,d,!1):b.detachEvent("on"+e,d)}};return l}},{"./doc":2}],7:[function(b,p,g){g.ottypes={};g.registerType=function(b){b.name&&(g.ottypes[b.name]=b);b.uri&&(g.ottypes[b.uri]=b)};g.registerType(b("ot-json0").type);g.registerType(b("ot-text").type);g.registerType(b("ot-text-tp2").type);b("./text-api");
b("./text-tp2-api")},{"./text-api":8,"./text-tp2-api":9,"ot-json0":12,"ot-text":18,"ot-text-tp2":15}],8:[function(b,p,g){b("ot-text").type.api={provides:{text:!0},getLength:function(){return this.getSnapshot().length},get:function(){return this.getSnapshot()},getText:function(){console.warn("`getText()` is deprecated; use `get()` instead.");return this.get()},insert:function(b,l,q){return this.submitOp([b,l],q)},remove:function(b,l,q){return this.submitOp([b,{d:l}],q)},_onOp:function(b){for(var l=
0,q=0;q<b.length;q++){var n=b[q];switch(typeof n){case "number":l+=n;break;case "string":if(this.onInsert)this.onInsert(l,n);l+=n.length;break;case "object":if(this.onRemove)this.onRemove(l,n.d)}}}}},{"ot-text":18}],9:[function(b,p,g){b=b("ot-text-tp2").type;var h=b._takeDoc,l=b._append,q=function(b,d,f,a){for(;(null==a||0<a)&&f.index<d.data.length;){var e=h(d,f,a,!0);null!=a&&"string"===typeof e&&(a-=e.length);l(b,e.length||e)}};b.api={provides:{text:!0},getLength:function(){return this.getSnapshot().charLength},
get:function(){for(var b=this.getSnapshot(),d=[],f=0;f<b.data.length;f++){var a=b.data[f];"string"==typeof a&&d.push(a)}return d.join("")},getText:function(){console.warn("`getText()` is deprecated; use `get()` instead.");return this.get()},insert:function(b,d,f){null==b&&(b=0);var a=[],e={index:0,offset:0},c=this.getSnapshot();q(a,c,e,b);l(a,{i:d});q(a,c,e);this.submitOp(a,f);return a},remove:function(b,d,f){var a=[],e={index:0,offset:0},c=this.getSnapshot();for(q(a,c,e,b);0<d;)b=h(c,e,d,!0),"string"===
typeof b?(l(a,{d:b.length}),d-=b.length):l(a,b);q(a,c,e);this.submitOp(a,f);return a},_beforeOp:function(){this.__prevSnapshot=this.getSnapshot()},_onOp:function(b){for(var d=0,f={index:0,offset:0},a=this.__prevSnapshot,e=0;e<b.length;e++){var c=b[e],r;if("number"==typeof c)for(r=c;0<r;r-=c.length||c)c=h(a,f,r),"string"===typeof c&&(d+=c.length);else if(null!=c.i){if("string"==typeof c.i){if(this.onInsert)this.onInsert(d,c.i);d+=c.i.length}}else for(r=c.d;0<r;r-=c.length||c)if(c=h(a,f,r),"string"==
typeof c&&this.onRemove)this.onRemove(d,c.length)}}}},{"ot-text-tp2":15}],10:[function(b,p,g){function h(){this._events=this._events||{};this._maxListeners=this._maxListeners||void 0}function l(b){return"function"===typeof b}function q(b){return"object"===typeof b&&null!==b}p.exports=h;h.EventEmitter=h;h.prototype._events=void 0;h.prototype._maxListeners=void 0;h.defaultMaxListeners=10;h.prototype.setMaxListeners=function(b){if("number"!==typeof b||0>b||isNaN(b))throw TypeError("n must be a positive number");
this._maxListeners=b;return this};h.prototype.emit=function(b){var d,f,a,e;this._events||(this._events={});if("error"===b&&(!this._events.error||q(this._events.error)&&!this._events.error.length)){d=arguments[1];if(d instanceof Error)throw d;throw TypeError('Uncaught, unspecified "error" event.');}f=this._events[b];if(void 0===f)return!1;if(l(f))switch(arguments.length){case 1:f.call(this);break;case 2:f.call(this,arguments[1]);break;case 3:f.call(this,arguments[1],arguments[2]);break;default:d=arguments.length;
a=Array(d-1);for(e=1;e<d;e++)a[e-1]=arguments[e];f.apply(this,a)}else if(q(f)){d=arguments.length;a=Array(d-1);for(e=1;e<d;e++)a[e-1]=arguments[e];f=f.slice();d=f.length;for(e=0;e<d;e++)f[e].apply(this,a)}return!0};h.prototype.addListener=function(b,d){var f;if(!l(d))throw TypeError("listener must be a function");this._events||(this._events={});this._events.newListener&&this.emit("newListener",b,l(d.listener)?d.listener:d);this._events[b]?q(this._events[b])?this._events[b].push(d):this._events[b]=
[this._events[b],d]:this._events[b]=d;q(this._events[b])&&!this._events[b].warned&&(f=void 0!==this._maxListeners?this._maxListeners:h.defaultMaxListeners)&&0<f&&this._events[b].length>f&&(this._events[b].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[b].length),"function"===typeof console.trace&&console.trace());return this};h.prototype.on=h.prototype.addListener;h.prototype.once=
function(b,d){function f(){this.removeListener(b,f);a||(a=!0,d.apply(this,arguments))}if(!l(d))throw TypeError("listener must be a function");var a=!1;f.listener=d;this.on(b,f);return this};h.prototype.removeListener=function(b,d){var f,a,e;if(!l(d))throw TypeError("listener must be a function");if(!this._events||!this._events[b])return this;f=this._events[b];e=f.length;a=-1;if(f===d||l(f.listener)&&f.listener===d)delete this._events[b],this._events.removeListener&&this.emit("removeListener",b,d);
else if(q(f)){for(;0<e--;)if(f[e]===d||f[e].listener&&f[e].listener===d){a=e;break}if(0>a)return this;1===f.length?(f.length=0,delete this._events[b]):f.splice(a,1);this._events.removeListener&&this.emit("removeListener",b,d)}return this};h.prototype.removeAllListeners=function(b){var d;if(!this._events)return this;if(!this._events.removeListener)return 0===arguments.length?this._events={}:this._events[b]&&delete this._events[b],this;if(0===arguments.length){for(d in this._events)"removeListener"!==
d&&this.removeAllListeners(d);this.removeAllListeners("removeListener");this._events={};return this}d=this._events[b];if(l(d))this.removeListener(b,d);else for(;d.length;)this.removeListener(b,d[d.length-1]);delete this._events[b];return this};h.prototype.listeners=function(b){return this._events&&this._events[b]?l(this._events[b])?[this._events[b]]:this._events[b].slice():[]};h.listenerCount=function(b,d){return b._events&&b._events[d]?l(b._events[d])?1:b._events[d].length:0}},{}],11:[function(b,
p,g){p.exports=function(b,l,q,n){var d=b.transformX=function(b,a){q(b);q(a);for(var e=[],c=0;c<a.length;c++){for(var r=a[c],u=[],k=0;k<b.length;){var t=[],m=b[k],h=t;l(u,m,r,"left");l(h,r,m,"right");k++;if(1===t.length)r=t[0];else{if(0===t.length)for(;k<b.length;k++)n(u,b[k]);else{k=d(b.slice(k),t);for(t=0;t<k[0].length;t++)n(u,k[0][t]);for(t=0;t<k[1].length;t++)n(e,k[1][t])}r=null;break}}null!=r&&n(e,r);b=u}return[b,e]};b.transform=function(b,a,e){if("left"!==e&&"right"!==e)throw Error("type must be 'left' or 'right'");
return 0===a.length?b:1===b.length&&1===a.length?l([],b[0],a[0],e):"left"===e?d(b,a)[0]:d(a,b)[1]}}},{}],12:[function(b,p,g){p.exports={type:b("./json0")}},{"./json0":13}],13:[function(b,p,g){function h(a){a.t="text0";var c={p:a.p.pop()};null!=a.si&&(c.i=a.si);null!=a.sd&&(c.d=a.sd);a.o=[c]}function l(a){a.p.push(a.o[0].p);null!=a.o[0].i&&(a.si=a.o[0].i);null!=a.o[0].d&&(a.sd=a.o[0].d);delete a.t;delete a.o}var q=function(a){return"[object Array]"==Object.prototype.toString.call(a)},n=function(a){return JSON.parse(JSON.stringify(a))},
d={name:"json0",uri:"http://sharejs.org/types/JSONv0"},f={};d.registerSubtype=function(a){f[a.name]=a};d.create=function(a){return void 0===a?null:n(a)};d.invertComponent=function(a){var c={p:a.p};a.t&&f[a.t]&&(c.t=a.t,c.o=f[a.t].invert(a.o));void 0!==a.si&&(c.sd=a.si);void 0!==a.sd&&(c.si=a.sd);void 0!==a.oi&&(c.od=a.oi);void 0!==a.od&&(c.oi=a.od);void 0!==a.li&&(c.ld=a.li);void 0!==a.ld&&(c.li=a.ld);void 0!==a.na&&(c.na=-a.na);void 0!==a.lm&&(c.lm=a.p[a.p.length-1],c.p=a.p.slice(0,a.p.length-1).concat([a.lm]));
return c};d.invert=function(a){a=a.slice().reverse();for(var c=[],r=0;r<a.length;r++)c.push(d.invertComponent(a[r]));return c};d.checkValidOp=function(a){for(var c=0;c<a.length;c++)if(!q(a[c].p))throw Error("Missing path");};d.checkList=function(a){if(!q(a))throw Error("Referenced element not a list");};d.checkObj=function(a){if(!a||a.constructor!==Object)throw Error("Referenced element not an object (it was "+JSON.stringify(a)+")");};d.apply=function(a,c){d.checkValidOp(c);c=n(c);for(var r={data:a},
b=0;b<c.length;b++){var k=c[b];null==k.si&&null==k.sd||h(k);for(var t=null,m=r,l="data",q=0;q<k.p.length;q++){var g=k.p[q],t=m,m=m[l],l=g;if(null==t)throw Error("Path invalid");}if(k.t&&void 0!==k.o&&f[k.t])m[l]=f[k.t].apply(m[l],k.o);else if(void 0!==k.na){if("number"!=typeof m[l])throw Error("Referenced element not a number");m[l]+=k.na}else if(void 0!==k.li&&void 0!==k.ld)d.checkList(m),m[l]=k.li;else if(void 0!==k.li)d.checkList(m),m.splice(l,0,k.li);else if(void 0!==k.ld)d.checkList(m),m.splice(l,
1);else if(void 0!==k.lm)d.checkList(m),k.lm!=l&&(t=m[l],m.splice(l,1),m.splice(k.lm,0,t));else if(void 0!==k.oi)d.checkObj(m),m[l]=k.oi;else if(void 0!==k.od)d.checkObj(m),delete m[l];else throw Error("invalid / missing instruction in op");}return r.data};d.shatter=function(a){for(var c=[],r=0;r<a.length;r++)c.push([a[r]]);return c};d.incrementalApply=function(a,c,r){for(var b=0;b<c.length;b++){var f=[c[b]];a=d.apply(a,f);r(f,a)}return a};var a=d.pathMatches=function(a,c,r){if(a.length!=c.length)return!1;
for(var d=0;d<a.length;d++)if(a[d]!==c[d]&&(!r||d!==a.length-1))return!1;return!0};d.append=function(e,c){c=n(c);if(0===e.length)e.push(c);else{var d=e[e.length-1];null==c.si&&null==c.sd||null==d.si&&null==d.sd||(h(c),h(d));if(a(c.p,d.p))if(c.t&&d.t&&c.t===d.t&&f[c.t]){if(d.o=f[c.t].compose(d.o,c.o),null!=c.si||null!=c.sd){for(var b=c.p,k=0;k<d.o.length-1;k++)c.o=[d.o.pop()],c.p=b.slice(),l(c),e.push(c);l(d)}}else null!=d.na&&null!=c.na?e[e.length-1]={p:d.p,na:d.na+c.na}:void 0!==d.li&&void 0===c.li&&
c.ld===d.li?void 0!==d.ld?delete d.li:e.pop():void 0!==d.od&&void 0===d.oi&&void 0!==c.oi&&void 0===c.od?d.oi=c.oi:void 0!==d.oi&&void 0!==c.od?void 0!==c.oi?d.oi=c.oi:void 0!==d.od?delete d.oi:e.pop():void 0!==c.lm&&c.p[c.p.length-1]===c.lm||e.push(c);else null==c.si&&null==c.sd||null==d.si&&null==d.sd||(l(c),l(d)),e.push(c)}};d.compose=function(a,c){d.checkValidOp(a);d.checkValidOp(c);for(var b=n(a),f=0;f<c.length;f++)d.append(b,c[f]);return b};d.normalize=function(a){var c=[];a=q(a)?a:[a];for(var b=
0;b<a.length;b++){var f=a[b];null==f.p&&(f.p=[]);d.append(c,f)}return c};d.commonLengthForOps=function(a,c){var d=a.p.length,b=c.p.length;(null!=a.na||a.t)&&d++;(null!=c.na||c.t)&&b++;if(0===d)return-1;if(0===b)return null;d--;b--;for(var f=0;f<d;f++){var t=a.p[f];if(f>=b||t!==c.p[f])return null}return d};d.canOpAffectPath=function(a,c){return null!=d.commonLengthForOps({p:c},a)};d.transformComponent=function(a,c,b,u){c=n(c);var k=d.commonLengthForOps(b,c),t=d.commonLengthForOps(c,b),m=c.p.length,
q=b.p.length;(null!=c.na||c.t)&&m++;(null!=b.na||b.t)&&q++;null!=t&&q>m&&c.p[t]==b.p[t]&&(void 0!==c.ld?(t=n(b),t.p=t.p.slice(m),c.ld=d.apply(n(c.ld),[t])):void 0!==c.od&&(t=n(b),t.p=t.p.slice(m),c.od=d.apply(n(c.od),[t])));if(null!=k){var g=m==q,t=b;null==c.si&&null==c.sd||null==b.si&&null==b.sd||(h(c),t=n(b),h(t));if(t.t&&f[t.t]){if(c.t&&c.t===t.t){k=f[c.t].transform(c.o,t.o,u);if(0<k.length)if(null!=c.si||null!=c.sd)for(u=c.p,b=0;b<k.length;b++)c.o=[k[b]],c.p=u.slice(),l(c),d.append(a,c);else c.o=
k,d.append(a,c);return a}}else if(void 0===b.na)if(void 0!==b.li&&void 0!==b.ld){if(b.p[k]===c.p[k]){if(!g)return a;if(void 0!==c.ld)if(void 0!==c.li&&"left"===u)c.ld=n(b.li);else return a}}else if(void 0!==b.li)void 0!==c.li&&void 0===c.ld&&g&&c.p[k]===b.p[k]?"right"===u&&c.p[k]++:b.p[k]<=c.p[k]&&c.p[k]++,void 0!==c.lm&&g&&b.p[k]<=c.lm&&c.lm++;else if(void 0!==b.ld){if(void 0!==c.lm&&g){if(b.p[k]===c.p[k])return a;u=b.p[k];t=c.p[k];g=c.lm;(u<g||u===g&&t<g)&&c.lm--}if(b.p[k]<c.p[k])c.p[k]--;else if(b.p[k]===
c.p[k]){if(q<m)return a;if(void 0!==c.ld)if(void 0!==c.li)delete c.ld;else return a}}else if(void 0!==b.lm)if(void 0!==c.lm&&m===q){if(t=c.p[k],g=c.lm,m=b.p[k],b=b.lm,m!==b)if(t===m)if("left"===u)c.p[k]=b,t===g&&(c.lm=b);else return a;else t>m&&c.p[k]--,t>b?c.p[k]++:t===b&&m>b&&(c.p[k]++,t===g&&c.lm++),g>m?c.lm--:g===m&&g>t&&c.lm--,g>b?c.lm++:g===b&&(b>m&&g>t||b<m&&g<t?"right"===u&&c.lm++:g>t?c.lm++:g===m&&c.lm--)}else void 0!==c.li&&void 0===c.ld&&g?(t=b.p[k],g=b.lm,u=c.p[k],u>t&&c.p[k]--,u>g&&c.p[k]++):
(t=b.p[k],g=b.lm,u=c.p[k],u===t?c.p[k]=g:(u>t&&c.p[k]--,u>g?c.p[k]++:u===g&&t>g&&c.p[k]++));else if(void 0!==b.oi&&void 0!==b.od){if(c.p[k]===b.p[k])if(void 0!==c.oi&&g){if("right"===u)return a;c.od=b.oi}else return a}else if(void 0!==b.oi){if(void 0!==c.oi&&c.p[k]===b.p[k])if("left"===u)d.append(a,{p:c.p,od:b.oi});else return a}else if(void 0!==b.od&&c.p[k]==b.p[k])if(g&&void 0!==c.oi)delete c.od;else return a}d.append(a,c);return a};b("./bootstrapTransform")(d,d.transformComponent,d.checkValidOp,
d.append);b=b("./text0");d.registerSubtype(b);p.exports=d},{"./bootstrapTransform":11,"./text0":14}],14:[function(b,p,g){p=p.exports={name:"text0",uri:"http://sharejs.org/types/textv0",create:function(b){if(null!=b&&"string"!==typeof b)throw Error("Initial data must be a string");return b||""}};var h=function(b,a,e){return b.slice(0,a)+e+b.slice(a)},l=function(b){if("number"!==typeof b.p)throw Error("component missing position field");if("string"===typeof b.i===("string"===typeof b.d))throw Error("component needs an i or d field");
if(0>b.p)throw Error("position cannot be negative");},q=function(b){for(var a=0;a<b.length;a++)l(b[a])};p.apply=function(b,a){var e;q(a);for(var c=0;c<a.length;c++){var d=a[c];if(null!=d.i)b=h(b,d.p,d.i);else{e=b.slice(d.p,d.p+d.d.length);if(d.d!==e)throw Error("Delete component '"+d.d+"' does not match deleted text '"+e+"'");b=b.slice(0,d.p)+b.slice(d.p+d.d.length)}}return b};var n=p._append=function(b,a){if(""!==a.i&&""!==a.d)if(0===b.length)b.push(a);else{var d=b[b.length-1];null!=d.i&&null!=a.i&&
d.p<=a.p&&a.p<=d.p+d.i.length?b[b.length-1]={i:h(d.i,a.p-d.p,a.i),p:d.p}:null!=d.d&&null!=a.d&&a.p<=d.p&&d.p<=a.p+a.d.length?b[b.length-1]={d:h(a.d,d.p-a.p,d.d),p:a.p}:b.push(a)}};p.compose=function(b,a){q(b);q(a);for(var d=b.slice(),c=0;c<a.length;c++)n(d,a[c]);return d};p.normalize=function(b){var a=[];if(null!=b.i||null!=b.p)b=[b];for(var d=0;d<b.length;d++){var c=b[d];null==c.p&&(c.p=0);n(a,c)}return a};var d=function(b,a,d){return null!=a.i?a.p<b||a.p===b&&d?b+a.i.length:b:b<=a.p?b:b<=a.p+a.d.length?
a.p:b-a.d.length};p.transformCursor=function(b,a,e){e="right"===e;for(var c=0;c<a.length;c++)b=d(b,a[c],e);return b};g=p._tc=function(b,a,e,c){l(a);l(e);if(null!=a.i)n(b,{i:a.i,p:d(a.p,e,"right"===c)});else if(null!=e.i)c=a.d,a.p<e.p&&(n(b,{d:c.slice(0,e.p-a.p),p:a.p}),c=c.slice(e.p-a.p)),""!==c&&n(b,{d:c,p:a.p+e.i.length});else if(a.p>=e.p+e.d.length)n(b,{d:a.d,p:a.p-e.d.length});else if(a.p+a.d.length<=e.p)n(b,a);else{c={d:"",p:a.p};a.p<e.p&&(c.d=a.d.slice(0,e.p-a.p));a.p+a.d.length>e.p+e.d.length&&
(c.d+=a.d.slice(e.p+e.d.length-a.p));var r=Math.max(a.p,e.p),u=Math.min(a.p+a.d.length,e.p+e.d.length);a=a.d.slice(r-a.p,u-a.p);r=e.d.slice(r-e.p,u-e.p);if(a!==r)throw Error("Delete ops delete different text in the same region of the document");""!==c.d&&(c.p=d(c.p,e),n(b,c))}return b};p.invert=function(b){b=b.slice().reverse();for(var a=0;a<b.length;a++){var d=b[a];b[a]=null!=d.i?{d:d.i,p:d.p}:{i:d.d,p:d.p}}return b};b("./bootstrapTransform")(p,g,q,n)},{"./bootstrapTransform":11}],15:[function(b,
p,g){p.exports={type:b("./text-tp2")}},{"./text-tp2":16}],16:[function(b,p,g){var h=p.exports={name:"text-tp2",tp2:!0,uri:"http://sharejs.org/types/text-tp2v1",create:function(a){if(null==a)a="";else if("string"!=typeof a)throw Error("Initial data must be a string");return{charLength:a.length,totalLength:a.length,data:a.length?[a]:[]}},serialize:function(a){if(!a.data)throw Error("invalid doc snapshot");return a.data},deserialize:function(a){var b=h.create();b.data=a;for(var d=0;d<a.length;d++){var c=
a[d];"string"===typeof c?(b.charLength+=c.length,b.totalLength+=c.length):b.totalLength+=c}return b}},l=Array.isArray||function(a){return"[object Array]"==Object.prototype.toString.call(a)},q=function(a){if(!l(a))throw Error("Op must be an array of components");for(var b=null,d=0;d<a.length;d++){var c=a[d];if("object"==typeof c)if(void 0!==c.i){if(!("string"===typeof c.i&&0<c.i.length||"number"===typeof c.i&&0<c.i))throw Error("Inserts must insert a string or a +ive number");}else if(void 0!==c.d){if(!("number"===
typeof c.d&&0<c.d))throw Error("Deletes must be a +ive number");}else throw Error("Operation component must define .i or .d");else{if("number"!=typeof c)throw Error("Op components must be objects or numbers");if(0>=c)throw Error("Skip components must be a positive number");if("number"===typeof b)throw Error("Adjacent skip components should be combined");}b=c}},n=h._takeDoc=function(a,b,c,d){if(b.index>=a.data.length)throw Error("Operation goes past the end of the document");a=a.data[b.index];c="string"==
typeof a?null!=c?a.slice(b.offset,b.offset+c):a.slice(b.offset):null==c||d?a-b.offset:Math.min(c,a-b.offset);d=c.length||c;(a.length||a)-b.offset>d?b.offset+=d:(b.index++,b.offset=0);return c},d=h._appendDoc=function(a,b){if(0!==b&&""!==b){"string"===typeof b?(a.charLength+=b.length,a.totalLength+=b.length):a.totalLength+=b;var c=a.data;0===c.length?c.push(b):typeof c[c.length-1]===typeof b?c[c.length-1]+=b:c.push(b)}};h.apply=function(a,b){if(null==a.totalLength||null==a.charLength||!l(a.data))throw Error("Snapshot is invalid");
q(b);for(var c=h.create(),e={index:0,offset:0},f=0;f<b.length;f++){var g=b[f],p,v;if("number"==typeof g)for(p=g;0<p;)v=n(a,e,p),d(c,v),p-=v.length||v;else if(void 0!==g.i)d(c,g.i);else if(void 0!==g.d){for(p=g.d;0<p;)v=n(a,e,p),p-=v.length||v;d(c,g.d)}}return c};var f=h._append=function(a,b){var c;0!==b&&""!==b.i&&0!==b.i&&0!==b.d&&(0===a.length?a.push(b):(c=a[a.length-1],"number"==typeof b&&"number"==typeof c?a[a.length-1]+=b:null!=b.i&&null!=c.i&&typeof c.i===typeof b.i?c.i+=b.i:null!=b.d&&null!=
c.d?c.d+=b.d:a.push(b)))},a=function(a,b,c,d){if(b.index===a.length)return null;a=a[b.index];var e,f=b.offset;if("number"==typeof(e=a)||"number"==typeof(e=a.i)||null!=(e=a.d))return null==c||e-f<=c||d&&null!=a.i?(c=e-f,++b.index,b.offset=0):b.offset+=c,null!=a.i?{i:c}:null!=a.d?{d:c}:c;null==c||a.i.length-f<=c||d?(d={i:a.i.slice(f)},++b.index,b.offset=0):(d={i:a.i.slice(f,f+c)},b.offset+=c);return d},e=function(a){return"number"===typeof a?a:"string"===typeof a.i?a.i.length:a.d||a.i};h.normalize=
function(a){for(var b=[],c=0;c<a.length;c++)f(b,a[c]);return b};var c=function(b,c,d,n){q(b);q(c);for(var m=[],g={index:0,offset:0},h=0;h<c.length;h++){var l=c[h],p=e(l);if(null!=l.i)if(d){if("left"===n)for(var x;(x=b[g.index])&&null!=x.i;)f(m,a(b,g));f(m,p)}else for(;0<p;){l=a(b,g,p,!0);if(null===l)throw Error("The transformed op is invalid");if(null!=l.d)throw Error("The transformed op deletes locally inserted characters - it cannot be purged of the insert.");"number"==typeof l?p-=l:f(m,l)}else for(;0<
p;){l=a(b,g,p,!0);if(null===l)throw Error("The op traverses more elements than the document has");f(m,l);l.i||(p-=e(l))}}for(;l=a(b,g);){if(void 0===l.i)throw Error("Remaining fragments in the op: "+l);f(m,l)}return m};h.transform=function(a,b,d){if("left"!=d&&"right"!=d)throw Error("side ("+d+") should be 'left' or 'right'");return c(a,b,!0,d)};h.prune=function(a,b){return c(a,b,!1)};h.compose=function(b,c){if(null==b)return c;q(b);q(c);for(var d=[],l={index:0,offset:0},m,g=0;g<c.length;g++){m=c[g];
var h;if("number"===typeof m)for(;0<m;){h=a(b,l,m);if(null===h)throw Error("The op traverses more elements than the document has");f(d,h);m-=e(h)}else if(void 0!==m.i)f(d,{i:m.i});else for(m=m.d;0<m;){h=a(b,l,m);if(null===h)throw Error("The op traverses more elements than the document has");var n=e(h);void 0!==h.i?f(d,{i:n}):f(d,{d:n});m-=n}}for(;m=a(b,l);){if(void 0===m.i)throw Error("Remaining fragments in op1: "+m);f(d,m)}return d}},{}],17:[function(b,p,g){function h(b,h){return{get:function(){return b()},
getLength:function(){return b().length},insert:function(b,d,f){return h([b,d],f)},remove:function(b,d,f){return h([b,{d:d}],f)},_onOp:function(b){for(var d=0,f=0;f<b.length;f++){var a=b[f];switch(typeof a){case "number":d+=a;break;case "string":if(this.onInsert)this.onInsert(d,a);d+=a.length;break;case "object":if(this.onRemove)this.onRemove(d,a.d)}}}}}p.exports=h;h.provides={text:!0}},{}],18:[function(b,p,g){g=b("./text");g.api=b("./api");p.exports={type:g}},{"./api":17,"./text":19}],19:[function(b,
p,g){g.name="text";g.uri="http://sharejs.org/types/textv1";g.create=function(a){if(null!=a&&"string"!==typeof a)throw Error("Initial data must be a string");return a||""};var h=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},l=function(a){if(!h(a))throw Error("Op must be an array of components");for(var b=null,c=0;c<a.length;c++){var d=a[c];switch(typeof d){case "object":if(!("number"===typeof d.d&&0<d.d))throw Error("Object components must be deletes of size > 0");
break;case "string":if(!(0<d.length))throw Error("Inserts cannot be empty");break;case "number":if(!(0<d))throw Error("Skip components must be >0");if("number"===typeof b)throw Error("Adjacent skip components should be combined");}b=d}if("number"===typeof b)throw Error("Op has a trailing skip");},q=function(a){return function(b){if(b&&0!==b.d)return 0===a.length?a.push(b):typeof b===typeof a[a.length-1]?"object"===typeof b?a[a.length-1].d+=b.d:a[a.length-1]+=b:a.push(b)}},n=function(a){var b=0,c=
0;return[function(d,f){if(b===a.length)return-1===d?null:d;var k;k=a[b];if("number"===typeof k){if(-1===d||k-c<=d)return k-=c,++b,c=0,k;c+=d;return d}if("string"===typeof k)return-1===d||"i"===f||k.length-c<=d?(k=k.slice(c),++b,c=0):(k=k.slice(c,c+d),c+=d),k;if(-1===d||"d"===f||k.d-c<=d)return k={d:k.d-c},++b,c=0,k;c+=d;return{d:d}},function(){return a[b]}]},d=function(a){0<a.length&&"number"===typeof a[a.length-1]&&a.pop();return a};g.normalize=function(a){for(var b=[],c=q(b),f=0;f<a.length;f++)c(a[f]);
return d(b)};g.apply=function(a,b){if("string"!==typeof a)throw Error("Snapshot should be a string");l(b);for(var c=[],d=0;d<b.length;d++){var f=b[d];switch(typeof f){case "number":if(f>a.length)throw Error("The op is too long for this document");c.push(a.slice(0,f));a=a.slice(f);break;case "string":c.push(f);break;case "object":a=a.slice(f.d)}}return c.join("")+a};g.transform=function(a,b,c){if("left"!=c&&"right"!=c)throw Error("side ("+c+") must be 'left' or 'right'");l(a);l(b);var f=[],h=q(f),
k=n(a);a=k[0];for(var k=k[1],g=0;g<b.length;g++){var m=b[g],p;switch(typeof m){case "number":for(;0<m;)p=a(m,"i"),h(p),"string"!==typeof p&&(m-="number"===typeof p?p:p.length||p.d);break;case "string":"left"===c&&"string"===typeof k()&&h(a(-1));h(m.length);break;case "object":for(m=m.d;0<m;)switch(p=a(m,"i"),typeof p){case "number":m-=p;break;case "string":h(p);break;case "object":m-=p.d}}}for(;m=a(-1);)h(m);return d(f)};g.compose=function(a,b){l(a);l(b);for(var c=[],f=q(c),h=n(a)[0],k=0;k<b.length;k++){var g=
b[k],m;switch(typeof g){case "number":for(;0<g;)m=h(g,"d"),f(m),"object"!==typeof m&&(g-="number"===typeof m?m:m.length||m.d);break;case "string":f(g);break;case "object":for(g=g.d;0<g;)switch(m=h(g,"d"),typeof m){case "number":f({d:m});g-=m;break;case "string":g-=m.length;break;case "object":f(m)}}}for(;g=h(-1);)f(g);return d(c)};var f=function(a,b){for(var c=0,d=0;d<b.length;d++){var f=b[d];if(a<=c)break;switch(typeof f){case "number":if(a<=c+f)return a;c+=f;break;case "string":c+=f.length;a+=f.length;
break;case "object":a-=Math.min(f.d,a-c)}}return a};g.transformSelection=function(a,b,c){var d=0;if(c){for(a=0;a<b.length;a++)switch(c=b[a],typeof c){case "number":d+=c;break;case "string":d+=c.length}return d}return"number"===typeof a?f(a,b):[f(a[0],b),f(a[1],b)]};g.selectionEq=function(a,b){null!=a[0]&&a[0]===a[1]&&(a=a[0]);null!=b[0]&&b[0]===b[1]&&(b=b[0]);return a===b||null!=a[0]&&null!=b[0]&&a[0]===b[0]&&a[1]==b[1]}},{}]},{},[4])(4)});

var Canvas = {};
window.Canvas = Canvas;

Canvas.connect = function(host, accessToken, collectionID, canvasID) {
  const socket = new WebSocket(host);
  socket._onopen = socket.onopen;
  socket.onopen = function() {
    socket.send('auth-token:' + accessToken);
    socket._onopen.apply(socket, arguments);
  };
  this._socket = socket;

  this._connection = new sharejs.Connection(this._socket);
  this._doc = this._connection.get(collectionID, canvasID);

  this._doc.subscribe();
  this._doc.whenReady(onDocReady);

  function onDocReady() {
    Canvas._sendMessage({
      "snapshot": Canvas._doc.snapshot
    });

    Canvas._context = this.createContext();
    Canvas._context.onInsert = onInsert;
    Canvas._context.onRemove = onDelete;
  }

  function onInsert(position, text) {
    Canvas._sendMessage({
      "op": {
        "type": "insert",
        "location": position,
        "text": text
      }
    });
  }

  function onDelete(position, length) {
    Canvas._sendMessage({
      "op": {
        "type": "remove",
        "location": position,
        "length": length
      }
    });
  }
};

Canvas.insert = function(location, string) {
  console.log("Insert:", {"location": location, "string": string});
  Canvas._context.insert(location, string);
};

Canvas.remove = function(location, length) {
  console.log("Remove:", {"location": location, "length": length});
  Canvas._context.remove(location, length);
};

Canvas._sendMessage = function(message) {
  console.log(message);
  if (typeof window.webkit != "undefined" && typeof window.webkit.messageHandlers != "undefined") {
    window.webkit.messageHandlers.share.postMessage(message);
  }
};
</script></body></html>
